---
title: "Untitled"
author: "O. Denas"
date: "November 20, 2016"
output:
  html_document:
    toc: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=3, fig.width=4)
```

```{r setup-code, echo=FALSE, message=FALSE}
rm(list=ls())
library(ggplot2)
library(dplyr)
library(knitr)
library(reshape2)

raw_ds <- (read.csv('aaa.txt', header = TRUE, stringsAsFactors = FALSE))


peak_space_ds <- function(raw_ds, item_set, label){
  size_s_f <- function(x) as.numeric(simplify2array(strsplit(x, "_"))[2,])
  
  (filter(raw_ds, item %in% item_set, measuring=="space") %>% 
     group_by(prefix, func, item) %>% summarise(value=sum(value)) %>%
     group_by(prefix, item) %>% summarise(value = max(value)) %>% 
     mutate(label = label, size_s = size_s_f(prefix)))
}

peak_mem_ds <- function(raw_ds, label){
  size_s_f <- function(x) as.numeric(simplify2array(strsplit(x, "_"))[2,])
  
  (filter(raw_ds, item == "total", measuring %in% c("resident_memory", "virtual_memory")) %>% 
     mutate(label = label, size_s = size_s_f(prefix)))
}

time_ds <- function(raw_ds){
  size_s_f <- function(x) as.numeric(simplify2array(strsplit(x, "_"))[2,])
  (filter(raw_ds, measuring=="time") %>% 
    select(prefix, func, item, value) %>% 
     mutate(size_s = size_s_f(prefix)))
}



bwt_usage <- function(){
  peak_space_ds(raw_ds, c("s_bwt_wtree", "s_bwt_bwt", "s_bwt_alp"), "bwt") %>% group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}

stree_usage <- function(){
  st_size_items <- c("s_stree_bp", "s_stree_bpsupp", 
                     "s_stree_bpsupp_select", "s_stree_bpsupp_rank")
  peak_space_ds(raw_ds, st_size_items, "stree") %>% group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}

vec_usage <- function(){
  st_size_items <- c("ms", "ms_select", 
                     "runs",  "runs_select", "runs_rank")
  peak_space_ds(raw_ds, st_size_items, "vec") %>% group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}

str_usage <- function(){
  peak_space_ds(raw_ds, c("s", "t"), "str") %>% group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}

```

# Report

Testing space usage on subsets of the `proteins.50MB` dataset from Pizza&Chilli. All tests were done on a prefix of the dataset of length |t| + |s|, for |t| = 1000 and various values of  |s|.

## Space usage
All figures are in bytes.

**TODO**:

 * the string `s` is not needed once the bwt is built
 * the `bwt` is not needed once its wavelet tree is built

The algorithm allocates space for

 * **bwt**, the BWT index.
 
     * `bwt_wtree` the wavelet tree, 
     * `alphabet, C` arrays of fixed size, `bwt` the actual BWT . 

 * **str**, the input strings `t` and `s`, `t` is fixed for all experiments `|t| =` `r peak_space_ds(raw_ds, c("t"), "t")$value[1]`

 * **stree**, the suffix tree topology
 
     * `stree_bp` balanced parenthesis bit vector, 
     * `stree_bp_supp` navigational support for the bp vector, 
     * rank and select support data structures for `stree_bp_supp`. 

 * **vec**, the following vectors 
 
     * `runs, ms` fixed for all the experiments. `|runs| =` `r peak_space_ds(raw_ds, c("runs"), "runs")$value[1]` and  `|ms| =` `r peak_space_ds(raw_ds, c("ms"), "ms")$value[1]`
     * `runs rank/select` support, `ms select` support.

Data structures, **bwt** and **stree** data structures are built for `s` and its reverse, but space for `s` is released before the space for its reverse is used.
 
Total space usage. The blue (green) line is the linear fit (identity line).

```{r}
total_use_ds <- (rbind(str_usage(), 
                      bwt_usage(), 
                      vec_usage(), 
                      stree_usage()) %>% 
                   group_by(prefix, size_s) %>% 
                   summarise(value=sum(value), label="total"))
fit <- lm(value ~ size_s, total_use_ds)
ggplot(total_use_ds, aes(size_s, value, color=label)) + geom_point() + geom_line() + labs(title=sprintf("space usage: %.2fB + %.4fB * size_s", coef(fit)[1], coef(fit)[2]), x="|s|", y="Bytes") + geom_abline(intercept=coef(fit)[1], slope=coef(fit)[2], color='blue', alpha=0.5) + geom_abline(intercept=0, slope=1, color='green', alpha=0.5)
```

Total space usage by component

```{r}
ggplot(rbind(str_usage(), bwt_usage(), vec_usage(), stree_usage()), aes(size_s, value, fill=label)) + geom_area() + labs(title="space usage by component", x="|s|", y="Bytes")

```

Total memory allocated by the OS

```{r}
ggplot(peak_mem_ds(raw_ds, "mem"), aes(size_s, value / (1024 * 1024))) + geom_bar(stat='identity') + facet_wrap(~measuring, scales = "free_y", nrow = 2) + labs(y = "GBytes (1GByte = 2e+20)")
```

## Time usage
Figures are in milliseconds. The blue line shows the linear fit.


```{r}
fit <- lm(value ~ size_s, time_ds(raw_ds) %>% group_by(prefix, size_s) %>% summarise(value=sum(value)))


ggplot(time_ds(raw_ds) %>% group_by(prefix, size_s) %>% summarise(value=sum(value)), aes(size_s, value)) + geom_line() + geom_point() + labs(title = sprintf("time usage: %.4f + %.4f ms * size_s", coef(fit)[1], coef(fit)[2]), y="milliseconds", x="|s|") + geom_abline(intercept=coef(fit)[1], slope=coef(fit)[2], color='blue', alpha=0.5)
```

# == scratch paper below ==


```{r}
rm(list=ls())
size_s_f <- function(x) as.numeric(simplify2array(strsplit(x, "_"))[2,])
read_f <- function(tp, stree, i)
  (read.csv(sprintf('%s_%s_%d.csv', tp, stree, i), stringsAsFactors = FALSE) %>% 
     filter(measuring == "time", item=="ms") %>% mutate(sample=tp, stree=stree, size_s=size_s_f(prefix)))

lazy_df <- rbind(do.call(rbind, lapply(1:5, function(i) read_f("lazy", "sada", i))),
                 do.call(rbind, lapply(1:5, function(i) read_f("lazy", "ohleb", i))))
nonlazy_df <- rbind(do.call(rbind, lapply(1:5, function(i) read_f("nonlazy", "sada", i))),
                 do.call(rbind, lapply(1:5, function(i) read_f("nonlazy", "ohleb", i))))


ggplot(rbind(lazy_df, nonlazy_df), aes(as.factor(size_s), value, color=sample)) + geom_boxplot() + facet_wrap(~stree)



```