---
title: "Untitled"
author: "O. Denas"
date: "November 20, 2016"
output:
  html_document:
    toc: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=3, fig.width=4)
```

```{r setup-code, echo=FALSE, message=FALSE}
rm(list=ls())
library(ggplot2)
library(dplyr)
library(knitr)
library(reshape2)

size_s_f <- function(x) 
  as.numeric(simplify2array(strsplit(x, "_"))[2,])

size_t_f <- function(x)
  as.numeric(sapply(simplify2array(strsplit(x, "_"))[1,], function(ss) substring(ss, 14)))

peak_space <- function(ds_, label){
  item_set <- c("alg", "bwt_bwt", "bwt_alp", "bwt_wtree", 
                "stree_bpsupp", "stree_bpsupp_select", "stree_bpsupp_rank",
                "ms", "runs")
  (filter(ds_, item %in% item_set, measuring=="space") %>% 
     mutate(label = label, size_s = size_s_f(prefix)))
}

system_space <- function(ds_, label)
  (filter(ds_, item %in% c("resident_mem", "virtual_mem"), measuring=="space") %>% 
     mutate(label = label, size_s = size_s_f(prefix)))

peak_time <- function(ds_, label)
  (filter(ds_, measuring=="time", item=="total_time") %>% 
     mutate(label = label, size_s = size_s_f(prefix), size_t = size_t_f(prefix)))



linear_fit_plot <- function(ds, fit, xlab, ylab){
  ggplot(ds, aes(size_s, value)) + geom_point() + geom_line() + 
    labs(title=sprintf("%.2f + %.4f * |s|", 
                       coef(fit)[1], coef(fit)[2]), x=xlab, y=ylab) + 
    geom_abline(intercept=coef(fit)[1], slope=coef(fit)[2], color='blue', alpha=0.5) + 
    geom_abline(intercept=0, slope=1, color='green', alpha=0.5)
}

bwt_usage <- function(ds_){
  filter(ds_, item %in% c("bwt_wtree", "bwt_bwt", "bwt_alp")) %>% 
    group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}

stree_usage <- function(ds_){
  st_size_items <- c("stree_bp", "stree_bpsupp", 
                     "stree_bpsupp_select", "stree_bpsupp_rank")
  filter(ds_, item %in% st_size_items) %>% 
    group_by(prefix, label) %>% 
    summarize(size_s=max(size_s), value=sum(value)) 
}

vec_usage <- function(ds_){
  filter(ds_, item %in% c("runs", "ms")) %>% 
    group_by(prefix, label) %>% summarize(size_s=max(size_s), value=sum(value)) 
}



raw_ds <- (read.csv('nonlazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE))

```

# Report

Testing space usage on subsets of the `proteins.50MB` dataset from Pizza&Chilli. All tests were done on a prefix of the dataset of length |t| + |s|, for |t| = 1000 and various values of  |s|.

## Space usage
All figures are in bytes.

**TODO**:

 * the string `s` is not needed once the bwt is built
 * the `bwt` is not needed once its wavelet tree is built

The algorithm allocates space for

 * **bwt**, the BWT index.
 
     * `bwt_wtree` the wavelet tree, 
     * `alphabet, C` arrays of fixed size, `bwt` the actual BWT . 

 * **str**, the input strings `t` and `s`, `t` is fixed for all experiments `|t| =` `r filter(raw_ds, item=="t")$value[1]`

 * **stree**, the suffix tree topology
 
     * `stree_bp` balanced parenthesis bit vector, 
     * `stree_bp_supp` navigational support for the bp vector, 
     * rank and select support data structures for `stree_bp_supp`. 

 * **vec**, the following vectors 
 
     * `runs, ms` fixed for all the experiments. `|runs| =` `r filter(raw_ds, item=="runs")$value[1]` and  `|ms| =` `r filter(raw_ds, item=="ms")$value[1]`
     * `runs rank/select` support, `ms select` support.

Data structures, **bwt** and **stree** data structures are built for `s` and its reverse, but space for `s` is released before the space for its reverse is used.
 
Total space usage. The blue (green) line is the linear fit (identity line).

```{r}
ds_ <- (peak_space(raw_ds, "total") %>% 
          group_by(label, size_s) %>% summarise(value=sum(value)))
linear_fit_plot(ds_, lm(value ~ size_s, ds_), "|s|", "bytes")

#total_use_ds <- (rbind(str_usage(),  bwt_usage(), vec_usage(), stree_usage()) %>% 
#                   group_by(prefix, size_s) %>% 
#                   summarise(value=sum(value), label="total"))
#fit <- lm(value ~ size_s, total_use_ds)
#ggplot(total_use_ds, aes(size_s, value, color=label)) + geom_point() + geom_line() + labs(title=sprintf("space usage: %.2fB + %.4fB * size_s", coef(fit)[1], coef(fit)[2]), x="|s|", y="Bytes") + geom_abline(intercept=coef(fit)[1], slope=coef(fit)[2], color='blue', alpha=0.5) + geom_abline(intercept=0, slope=1, color='green', alpha=0.5)
```

Total space usage by component

```{r}

ggplot(rbind(bwt_usage(peak_space(raw_ds, "bwt")), 
             stree_usage(peak_space(raw_ds, "stree")),
             vec_usage(peak_space(raw_ds, "vec"))), aes(size_s, value, fill=label)) + geom_area() + labs(title="space usage by component", x="|s|", y="Bytes")

```

Total memory allocated by the OS

```{r}

ggplot(system_space(raw_ds, "mem"), aes(size_s, value / (1024 * 1024))) + geom_bar(stat='identity') + facet_wrap(~item, scales = "free_y", nrow = 2) + labs(y = "GBytes (1GByte = 2e+20)")
```

## Time usage
Figures are in milliseconds. The blue line shows the linear fit.


```{r}
ds_ <- (peak_time(raw_ds, "total") %>% 
          group_by(label, size_s) %>% summarise(value=sum(value)))
linear_fit_plot(ds_, lm(value ~ size_s, ds_), "|s|/100", "ms")
```

### Lazy vs. non lazy
```{r}
ds_ <- rbind(peak_time(read.csv('lazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE), label="lazy"), 
             peak_time(read.csv('nonlazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE), label="nonlazy"))

#ggplot(ds_, aes(size_s, value, color=label)) + geom_jitter()

dds_ <- data.frame(lazy = ds_ %>% group_by(label, size_s) %>% 
                     summarise(value = sum(value) / 5) %>% filter(label=="lazy"),
                   nonlazy = ds_ %>% group_by(label, size_s) %>% 
                     summarise(value = sum(value) / 5) %>% filter(label=="nonlazy"))
ds_
#ggplot(dds_, aes(lazy.value, nonlazy.value)) + geom_point() + geom_abline(slope=1, intercept=0)
#ggplot(ds_, aes(size_s, value, fill=label)) + geom_bar(stat='identity', position="dodge") + scale_x_log10() + scale_y_log10()

ggplot(ds_, aes(as.factor(size_s), value, color=label)) + geom_boxplot() + geom_point(aes(color=label))

```



# == scratch paper below ==


```{r, eval=FALSE}
#rm(list=ls())

ggplot(aa, aes(size_s, value, color=label)) + geom_point()



ggplot(rbind(peak_time(lazy, "lazy"), peak_time(nonlazy, "nonlazy")), 
       aes(as.factor(size_s), value, color=label, fill=label)) + geom_boxplot() + facet_wrap(~item, nrow = 2) + geom_jitter(aes(color=label), alpha=0.3)



```