---
title: "Untitled"
author: "O. Denas"
date: "November 20, 2016"
output:
  html_document:
    toc: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=3, fig.width=4)
```

```{r setup-code, echo=FALSE, message=FALSE}
rm(list=ls())
source('utils.R')

raw_ds <- (read.csv('nonlazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE))

```

# Report

Testing space usage on subsets of the `proteins.50MB` dataset from Pizza&Chilli. All tests were done on a prefix of the dataset of length |t| + |s|, for |t| = 1000 and various values of  |s|.

## Space usage
All figures are in bytes.

**TODO**:

 * the string `s` is not needed once the bwt is built
 * the `bwt` is not needed once its wavelet tree is built

The algorithm allocates space for

 * **bwt**, the BWT index.
 
     * `bwt_wtree` the wavelet tree, 
     * `alphabet, C` arrays of fixed size, `bwt` the actual BWT . 

 * **str**, the input strings `t` and `s`, `t` is fixed for all experiments `|t| =` `r filter(raw_ds, item=="t")$value[1]`

 * **stree**, the suffix tree topology
 
     * `stree_bp` balanced parenthesis bit vector, 
     * `stree_bp_supp` navigational support for the bp vector, 
     * rank and select support data structures for `stree_bp_supp`. 

 * **vec**, the following vectors 
 
     * `runs, ms` fixed for all the experiments. `|runs| =` `r filter(raw_ds, item=="runs")$value[1]` and  `|ms| =` `r filter(raw_ds, item=="ms")$value[1]`
     * `runs rank/select` support, `ms select` support.

Data structures, **bwt** and **stree** data structures are built for `s` and its reverse, but space for `s` is released before the space for its reverse is used.
 
Total space usage. The blue (green) line is the linear fit (identity line).

```{r}
ds_ <- (peak_space(raw_ds, "total") %>% 
          group_by(label, size_s) %>% summarise(value=sum(value)))
linear_fit_plot(ds_, lm(value ~ size_s, ds_), "|s|", "bytes")

#total_use_ds <- (rbind(str_usage(),  bwt_usage(), vec_usage(), stree_usage()) %>% 
#                   group_by(prefix, size_s) %>% 
#                   summarise(value=sum(value), label="total"))
#fit <- lm(value ~ size_s, total_use_ds)
#ggplot(total_use_ds, aes(size_s, value, color=label)) + geom_point() + geom_line() + labs(title=sprintf("space usage: %.2fB + %.4fB * size_s", coef(fit)[1], coef(fit)[2]), x="|s|", y="Bytes") + geom_abline(intercept=coef(fit)[1], slope=coef(fit)[2], color='blue', alpha=0.5) + geom_abline(intercept=0, slope=1, color='green', alpha=0.5)
```

Total space usage by component

```{r}

ggplot(rbind(bwt_usage(peak_space(raw_ds, "bwt")), 
             stree_usage(peak_space(raw_ds, "stree")),
             vec_usage(peak_space(raw_ds, "vec"))), aes(size_s, value, fill=label)) + geom_area() + labs(title="space usage by component", x="|s|", y="Bytes")

```

Total memory allocated by the OS

```{r}

ggplot(system_space(raw_ds, "mem"), aes(size_s, value / (1024 * 1024))) + geom_bar(stat='identity') + facet_wrap(~item, scales = "free_y", nrow = 2) + labs(y = "GBytes (1GByte = 2e+20)")
```

## Time usage
Figures are in milliseconds. The blue line shows the linear fit.


```{r}
ds_ <- (peak_time(raw_ds, "total") %>% 
          group_by(label, size_s) %>% summarise(value=sum(value)))
linear_fit_plot(ds_, lm(value ~ size_s, ds_), "|s|/100", "ms")
```

### Lazy vs. non lazy
```{r}
ds_ <- rbind(peak_time(read.csv('lazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE), label="lazy"), 
             peak_time(read.csv('nonlazy_protein_benchmark.csv', header = TRUE, stringsAsFactors = FALSE), label="nonlazy"))

#ggplot(ds_, aes(size_s, value, color=label)) + geom_jitter()

dds_ <- data.frame(lazy = ds_ %>% group_by(label, size_s) %>% 
                     summarise(value = sum(value) / 5) %>% filter(label=="lazy"),
                   nonlazy = ds_ %>% group_by(label, size_s) %>% 
                     summarise(value = sum(value) / 5) %>% filter(label=="nonlazy"))
ds_
#ggplot(dds_, aes(lazy.value, nonlazy.value)) + geom_point() + geom_abline(slope=1, intercept=0)
#ggplot(ds_, aes(size_s, value, fill=label)) + geom_bar(stat='identity', position="dodge") + scale_x_log10() + scale_y_log10()

ggplot(ds_, aes(as.factor(size_s), value, color=label)) + geom_boxplot() + geom_point(aes(color=label))

```



# == scratch paper below ==


```{r, eval=FALSE}
#rm(list=ls())

ggplot(aa, aes(size_s, value, color=label)) + geom_point()



ggplot(rbind(peak_time(lazy, "lazy"), peak_time(nonlazy, "nonlazy")), 
       aes(as.factor(size_s), value, color=label, fill=label)) + geom_boxplot() + facet_wrap(~item, nrow = 2) + geom_jitter(aes(color=label), alpha=0.3)



```