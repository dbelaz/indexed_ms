---
title: "Lazy vs. non lazy"
author: "O. Denas"
date: "12/28/2016"
output:
  pdf_document: 
    number_sections: yes
    toc: yes
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Double vs. single rank

```{r, echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
rm(list=ls())
source('utils.R')

time_ds <- (read_ds('lazy_vs_nonlazy_data/single_rank_vs_double_rank.csv') %>% 
              filter(measuring == "time"))
cast_time_ds <- (cbind(filter(time_ds, unit == "runs", item == "dstruct") %>% 
                        select(len_s, len_t, label),
                      filter(time_ds, unit == "runs", item == "dstruct") %>% 
                        transmute(runs_ds = value),
                      filter(time_ds, unit == "runs", item == "alg") %>% 
                        transmute(runs_alg = value),
                      filter(time_ds, unit == "ms", item == "dstruct") %>% 
                        transmute(ms_ds = value),
                      filter(time_ds, unit == "ms", item == "alg") %>% 
                        transmute(ms_alg = value)) %>% 
                   mutate(total_alg = (ms_alg + runs_alg), 
                          total_ds = (ms_ds + runs_ds)))
ggplot(cast_time_ds, aes(as.factor(len_s), total_alg/1000, color=label)) + geom_boxplot() + 
  labs(title = "algorithm time on protein data", subtitle="|s|=10^6, |t|=10^5") + ylab('seconds') + xlab("|s|")
```


# Lazy vs non-lazy
## Run time
```{r, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())
source('utils.R')

time_ds <- read_ds('lazy_vs_nonlazy_data/lazy_vs_nonlazy.csv') %>% 
              filter(unit %in% c("ms", "runs"), item %in% c("alg")) %>% select(len_s, unit, value, item, label, b_path)

ggplot(time_ds, aes(b_path, value, fill=label)) + 
  geom_bar(stat='identity', position='dodge') + 
  labs(title = "algorithm time", subtitle="|s|=1.28e+8, |t|=2e+3") + ylab('ms') + xlab("input type") + theme(axis.text.x = element_text(angle = 90, hjust = 1))  
```


## Sandbox timing
Measure the time of 10k repetitions of 

 (1) $n$ consecutive `lazy_wl()` calls followed by a `lazy_wl_followup()` and 
 (2) $n$ consecutive `wl()` calls


```{r, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())
source('utils.R')

ds <- read.csv('lazy_vs_nonlazy_data/sandbox_timing.csv', stringsAsFactors = FALSE) %>% filter(item != "dstruct")

fit_lazy <- lm(time_ms ~ nwlcalls, data=(ds %>% filter(item=="lazy"))); #coef(fit_lazy)
fit_nonlazy <- lm(time_ms ~ nwlcalls, data=(ds %>% filter(item!="lazy"))); #coef(fit_nonlazy)
fit <- lm(time_ms ~ aa + nwlcalls, data=ds %>% mutate(aa = item!="lazy")); #summary(fit)

ggplot(ds, aes(nwlcalls, time_ms,color=item)) + geom_point() + 
  geom_abline(intercept = coef(fit_lazy)[1], slope = coef(fit_lazy)[2], color='red', alpha=0.5) + 
  geom_abline(intercept = coef(fit_nonlazy)[1], slope = coef(fit_nonlazy)[2], color='green', alpha=0.5) +
  labs(title=sprintf("rutime of lazy_wl() vs. wl() calls on input size %d", ds$s[1]), 
       subtitle=sprintf("lazy: %.2f + %.4f*n; nonlazy: %.2f + %.4f*n", 
                        coef(fit_lazy)[1], coef(fit_lazy)[2],
                        coef(fit_nonlazy)[1], coef(fit_nonlazy)[2]), 
       x="n (i.e. the nr. of consecutive wl() calls)", 
       y=sprintf("time of %d repetitions (ms)", ds$ntrials[1])) + 
  expand_limits(x=0,y=0) + 
  scale_x_continuous(breaks=0:10)
```



## Input properties

For various types ("mut_XMs_YMt_Z" means `s` and `t` are random identical strings of length X, and Y million respectively with mutations inserted every Z characters. "rnd_XMs_YMt" means `s` and `t` are random strings of length X, and Y million respectively) of inputs run the MS algorithm and count the number of consecutive `lazy_wl()` calls.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
lazy_calls <- sapply(1:3000, function(i) sprintf("consecutive_lazy_wl_calls%d", i))

ds <- read_ds('lazy_vs_nonlazy_data/lazy.csv') %>% filter(item %in% lazy_calls, label=="lazy") %>% mutate(count = value)
ds$nwlcalls = as.numeric(sapply(ds$item, function(s) substr(s, 26, 300)))

ggplot(ds, aes(factor(nwlcalls), count)) + geom_bar(stat='identity') + facet_wrap(~b_path, scale='free')+ theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Using the linear fits above, this is the expected toal time the `wl()` or `lazy_wl()` calls should take (in ms).

```{r, echo=FALSE, warning=FALSE, message=FALSE}
wl_time_ds <- ds %>% 
  mutate(lazy_t = value * predict(fit_lazy, data.frame(nwlcalls = nwlcalls)) / 10000,
         nonlazy_t = value * predict(fit_nonlazy, data.frame(nwlcalls = nwlcalls)) / 10000) %>% 
  group_by(b_path) %>% summarise(lazy_t = sum(lazy_t), 
                                 nonlazy_t = sum(nonlazy_t))

wl_time_ds %>% mutate(abs_diff_ms = lazy_t - nonlazy_t, 
                      rel_diff_ms = 100 * (lazy_t - nonlazy_t) / apply(cbind(lazy_t, nonlazy_t), 1, max))
ggplot(melt(wl_time_ds, id.vars = "b_path", measure.vars = c("lazy_t", "nonlazy_t")), aes(b_path, value, fill=variable)) + geom_bar(stat="identity", position="dodge")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  labs(title="expected runtime of the ms array (CST construction excluded) in seconds.") 
```
