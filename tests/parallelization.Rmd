---
title: "Parallel tests"
author: "O. Denas"
date: "3/16/2017"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Parallelization
```{r, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())
source('utils.R')

lazy_calls <- sapply(0:3000, function(i) sprintf("consecutive_lazy_wl_calls%d", i))
read_all <- function() do.call(rbind, lapply(list.files('parallelization_data/', 'results.*.threads.csv'), function(n) read_ds(sprintf('parallelization_data/%s', n))))

ggplot(read_all() %>% filter(measuring == "time", !(item %in% lazy_calls)), aes(factor(nthreads), value/1000)) + geom_boxplot() + facet_wrap(~item, scales = "free_y") + ylab('seconds') + labs(title = "Time usage")


alloc_str <- sapply(0:30, function(i) sprintf("ms_bvector_allocated%d", i))
used_str <- sapply(0:30, function(i) sprintf("ms_bvector_used%d", i))

## THIS IS ALL CONSTANT ##
#ggplot(read_all() %>% filter(measuring == "space", !(item %in% alloc_str), !(item %in% used_str), item!="ms_bvector"), aes(factor(nthreads), value/1000000)) + geom_bar(stat='identity') + facet_wrap(~item, scales = "free_y") + ylab('MB')


aa <- (read_all() %>% 
         filter(measuring == "space", item %in% alloc_str) %>% 
         group_by(len_s, len_t, measuring, label, b_path, nthreads) %>% 
         summarise(value = mean(value), item="ms_bvector_allocated") %>% 
         mutate(value = value * nthreads))

bb <- (read_all() %>% 
         filter(measuring == "space", item %in% used_str) %>%
         group_by(len_s, len_t, measuring, label, b_path, nthreads, item) %>% 
         summarise(value = mean(value)) %>% 
         group_by(len_s, len_t, measuring, label, b_path, nthreads) %>% 
         summarise(value = sum(value), item="ms_bvector_used"))

ggplot(rbind(aa, bb), aes(factor(nthreads), value / 1000000, fill=item, group=item, color=item)) + geom_bar(stat='identity', position='dodge')  + ylab('MB') + labs(title = "Space usage")
```
