/*
 * fabio_djamal_ms.cpp
 *
 *  Created on: Oct 13, 2016
 *      Author: denas
 */

#include <iostream>
#include <string>
#include <sdsl/suffix_arrays.hpp>
#include <sdsl/suffix_trees.hpp>
#include <sdsl/wavelet_trees.hpp>
#include <sdsl/bp_support.hpp>
#include <sdsl/csa_wt.hpp>
#include <sdsl/bit_vectors.hpp>

#include "fd_ms.hpp"


using namespace std;
//using namespace sdsl;
using namespace fdms;

Mstat compute_ms(string& T,
                 string& Sfwd, string& Sfwdbp,
                 string& Srev, string& Srevbp,
                 const bool verbose){

    bit_vector bfwd(Sfwdbp.size()), brev(Srevbp.size());
    for(size_type i=0; i<Sfwdbp.size(); i++)
        bfwd[i] = ((unsigned char)Sfwdbp[i] - 48);
    for(size_type i=0; i<Srevbp.size(); i++)
        brev[i] = ((unsigned char)Srevbp[i] - 48);

    fdms::bp_support_sada<> Bpsfwd(&bfwd);
    fdms::bp_support_sada<> Bpsrev(&brev);

    if(verbose){
        cst_sct3<> st_of_s, st_of_s_rev;
        construct_im(st_of_s, Sfwd, 1);
        //construct_im(st_of_s_rev, Srev, 1);

        cout << " i SA ISA PSI LF BWT   T[SA[i]..SA[i]-1]" << endl;
        csXprintf(cout, "%2I %2S %3s %3P %2p %3B   %:3T", st_of_s.csa);
        //cout << " i SA ISA PSI LF BWT   T[SA[i]..SA[i]-1]" << endl;
        //csXprintf(cout, "%2I %2S %3s %3P %2p %3B   %:3T", st_of_s_rev.csa);
    }

    Bwt Bwtfwd(Sfwd);
    /*
    for(size_type i=0; i < Bwtfwd.bwt_len; i++)
        cout << Bwtfwd[i] << endl;

    cout << "rank, 'a': ";
    for(size_type i=0; i <= Bwtfwd.bwt_len; i++)
        cout << (int) Bwtfwd.rank(i, 'a');
    cout << endl << "select, 'a': ";
    for(size_type i=1; i <= Bwtfwd.rank(Bwtfwd.bwt_len, 'a'); i++)
        cout << (int) Bwtfwd.select(i, 'a');
    cout << endl;

    cout << "rank, 'b': ";
    for(size_type i=0; i <= Bwtfwd.bwt_len; i++)
        cout << (int) Bwtfwd.rank(i, 'b');
    cout << endl << "select, 'b': ";
    for(size_type i=1; i <= Bwtfwd.rank(Bwtfwd.bwt_len, 'b'); i++)
        cout << (int) Bwtfwd.select(i, 'b');
    cout << endl;


    for(size_type i=0; i<Bwtfwd.bwt_len; i++){
        cout << "LF(" << i << ") = " << Bwtfwd.lf(i) << endl;
    }

    for(size_type i=0; i<Bwtfwd.bwt_len; i++){
        cout << "LF^-1(" << i << ") = " << Bwtfwd.lf_rev(i) << endl;
    }

    for(size_type i=0; i<Bwtfwd.bwt_len; i++){
        cout << "LF(LF^-1(" << i << ")) = " << Bwtfwd.lf(Bwtfwd.lf_rev(i)) << endl;
    }
     */

    Bwt Bwtrev(Srev);

    Mstat MS(T,
             Sfwd, Bwtfwd, Bpsfwd,
             Srev, Bwtrev, Bpsrev,
             verbose);

    return MS;
}


int main(int argc, char **argv){
    string T, S, Sbp, Srev, Srevbp;

    if(argc == 2){ // process file
        std::ifstream in_file {argv[1]};
        if(!in_file){
            cout << "could not open file " << argv[1] << endl;
            return 1;
        }

        while (in_file >> T >> S >> Sbp >> Srev >> Srevbp){
            cout << T + " " + S + " ";
            compute_ms(T, S, Sbp, Srev, Srevbp, 0).dump();
        }
    } else {
        string T {"ababbbaabbbaabababbaaaabaabaabbaabaabbabbaabbbababbbaaaaabaabaabbbbaabbbbbbbbaaabaaaaabbbabbaabaaabbabbabaabbaaaababbaabaaaabababbabbbaabbaaaaaaabaaabababbbbabbbaaababbbbabaaaabbabbaabaaabbabababbbbaaababbbaaaababbbaababaaaabbabaaaaabaabaababbaaaabbbabbaaabaabbabbbaabaabbbbaabbaabaabaababaabbbbabbaababaabbabaaabbabaaabababbbbaabbaaabaaaaabaaabbaabbbaaaaabbabbabbbaabbbababbaaaaaababbababbabaabbabbbabaaababaaaabaababaababbbbbabaabbbbbbabbaabbbbbaababbaaaaaaaabaaabaabbabbbababaaababbbaaaaabbbabbbbaaaabaaabaaaaaabaaaaaaabbbbabbbbbaababbbaabaabbbbababbbaabbaaaaaabbbabaaaabaaaaabaaabbbabbbabbbbabaaa"};
        string S {"bbbbbaabaabbbbaaaabaaaababbbaaabbaaabbbbbbbaababbbbbbbabababaabaababbaaaabbbababaabbabbabaabbabaabbbaaaaabaabbaabbaaababaabbbabababaabaabbababbbabaabbbbabaaabbabaabaabbbaabaaabaababbaababbabbbbbbbababbbaaabbabaabaabbabbbbabbaaababaababbaabaaaaaabaaabaabbaababaabbbaaababaabbbbaaaabaaabbaabaaabbbaaababaaaabbbaaaabbbaababaaabbaababbbbbaaaabbabaabaaabbbabbbbbaabbbaaababbaaaabbaabbaabbababbbbabbbababbbbbbbaabbbbaababbaaabbbabaaaaababbbabbabaaaaaabbbbaabbbaaaabbbbbbaabaaaababaababbaababbbaababababbabbbabbabaabababbbbbaaabababbbbbaabbabaaabaabaaabbbbbbabaaabaabaabbaaaaaabababbabaabbaabbaaabababbaabaa"};
        string Sbp {"1101101101111110100100111101001101000100011111011010001001110100110100001110100111101001001101000000111110110100011110100100110100001111011101001101000011101001000110110100000111101110100100011011010000111110100100111010010001101110100100000001111011101101000111010011011101001000001111010011010001111011010001101000110100000111110100111010011101001000011011101001101000001111110100100110110100001001111010010011010000001111101110100100011101101000111101001001000011110111011010001000110100011010000111111011010001110100100011010001110110100010001111101001101000100111010010000000111101111101001001110100100011111010010010011110100100111010010000011111010011011101101000100001101101101101000000111101101101000011101001101000011111010010010011101001000000111110100111101001101000110111010010000011110100100111011010001101000001111110100100111010011010000110110100001111101001001101000110111101001001101000000001111110110100011110100100110100001111011010001101101101000001111010010010000111110100111101101000100111010010000110100011011011010000001111110110100011110100100110100001101101000011110100111010010001110100100001111101001101000110110100001111010011010001110100111010011010000000000111101111110100100110100011110100110100011101001111010010010000011111101001001001111011011010000110100010001111011010001101000111011010001101000000111101110100110111010010000110111011010001101000001111010011010001111101001101101000010011011010000001111101101000110111010010000111101001101000110100001111110100110100010010011110100100100000011111110100100111010011010000111101101110100100001101101000011101101000111101001001101000000111110100100111010010001110110100011101001101110100100000001111110100110100011101001101000011101101101000011010000111110100100111010011010000111010011110100110100011011010000000001111111010011101001110100111010010000011111011011010000110100010011101001101000001111011101001101000100111101001001110100110110100000011111010010011010001110100100000111111010011101001000111101101000100111010011010000011101101000111010011010000011101101101000011101001101101000000011111101110100110110100000111110100100100110100001111101001001110100110100001101110100100000111110110100010011101101000110100001110110100011010000011111110100100100111101001101000110111010010000011110100110100011010000111110100111101001001101101000001101101000011111010010011011010000111010011010000000000"};
        string Srev {"aabaabbababaaabbaabbaababbababaaaaaabbaabaabaaababbbbbbaaabaabaaababbaabbbbbababaaabbbbbababaababbabbbabbabababaabbbabaabbabaababaaaabaabbbbbbaaaabbbaabbbbaaaaaababbabbbabaaaaababbbaaabbabaabbbbaabbbbbbbababbbabbbbababbaabbaabbaaaabbabaaabbbaabbbbbabbbaaabaababbaaaabbbbbabaabbaaababaabbbaaaabbbaaaababaaabbbaaabaabbaaabaaaabbbbaababaaabbbaababaabbaabaaabaaaaaabaabbabaababaaabbabbbbabbaabaababbaaabbbababbbbbbbabbabaabbabaabaaabaabbbaabaababbaaababbbbaababbbababbaabaababababbbaababaaabbaabbaabaaaaabbbaababbaababbabbaabababbbaaaabbabaabaababababbbbbbbabaabbbbbbbaaabbaaabbbabaaaabaaaabbbbaabaabbbbb"};
        string Srevbp {"11011111111010010011101101000110100001111011010001101101000011101101000111011010001110100100000011111011010001110100111010011010000011101001110100110110100000011110110110100001110110100010001111101001110100110100001101000111010011010000000111111101001101000111010011010000111101001110100110110100000111011010001101101000000111110111010011010000110100011101001000111110110100011010001101101101000001110100110100000011111011101001000111110100100100110110100000111101111010011010001000100100011111101001001110110100011010000111010010001110111010010001101110110100010011011010000000001111111101001101000111010011010000111101001101000111101001001110110100010000011111011010001001111010011010001110110100010000111110100100111011010001000111101001001101101101000000001111110100111101001001110100100001101101101000001110110100011101001000011111011010001110100110100001101101101000001111101001001101000110110110100000000111111010011101101000110100001111101001101101000011011010000111011101001000100001111011110100110100011010000111010010001101110100100000111111011010001110100100011101110100100011010000111110100100110100011010000111101110110100010001101000110111011010001001110100110111010010000000000110111111110100100110100011110100100111010011101001110100100000011111010011101001101000011011011010000011110110100011010001111011010001101000100000111110111010011010000111011101001101000010001111101110100100010011101001000111110110100010011011010000100001111101101000111101001001000111011010001000111101001001110100110110100110110100000000011111110100110100011110100100111011010001000011110100111010010001111010011010001110100110100000011111011010001101000110110100001110100111101001001101000000111110110100011110100110100011010000111011010001101101000001111101101000100111010011010000111011010001101101000000001101111101101110100111010010000011110111010010001101000111010011010000011111010011101101101000010001111101001001001110110100010000111011101001000110111010010000001111110100100111101001101000111011010001101000001111101101000100100111010011010000011110100110100011101101000110100000011011111011011011010000011110100100110100001111010011110100100110100001101101000001111101001110100100011101001110100110100000111011010001101000001101111101001101000111011010001000111101001110100110100001110100100001101110110100011110100111010010001101000011110110100011101001000110111010010000000000"};

        memory_monitor::start();
        compute_ms(T, S, Sbp, Srev, Srevbp, 1).dump();
        memory_monitor::stop();
        cout << memory_monitor::peak() << " bytes." << endl;

        //cout << "usage: " << argv[0] << "<file of strings>" << endl;
        //cout << "or" << endl;
        //cout << "usage: " << argv[0] << "<T> <S>" << endl;
        //return 1;
    }

    return 0;
}

